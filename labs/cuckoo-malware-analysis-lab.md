# Building a malware analysis lab with cuckoo

I gotta say I was inspired by this [great article](https://rastamouse.me/2017/05/playing-with-cuckoo/) by Rastamouse and decided to build my own lab. I try to address some of the things that didn't work perfectly when setting this up and some more details. The result is the same so I'm not gonna try to not steal his exact wording.

* Physical Host OS: Windows 10 with VMWare Workstation
* Cuckoo Host OS: Ubuntu Server 16.04 64-bit
* Virtual OS inside: Windows 7 and Windows 10, both 64-bit

## Configuring the Cuckoo host
I followed Rasta's guide and gave the Ubuntu server the following spect:
* 8 CPU Cores
    * Tick `Enable Virtualize Intel VT-x/EPT or AMD-V/RVI`
* 4GB RAM
* 100GB Hard Disk
* NIC 1: Bridged (we will change it to NAT later)
* NIC 2: Host-Only

### Setting up VMWare
In VMWare workstation, go to edit virtual network editor, change the ip subnet to 192.168.56.0 and enable DHCP.

### Installing software
First install the requirements to get Cuckoo and Virtualbox up
```
cd ~
sudo apt update
sudo apt install python python-pip python-dev libffi-dev libssl-dev python-virtualenv python-setuptools libjpeg-dev zlib1g-dev swig mongodb python-pip virtualbox tcpdump apparmor-utils
```

Install some additional tools
```
sudo apt install git vim cifs-utils smbclient terminator unzip xfce4 firefox
```

If you want you can now boot to the graphical user environment XFCE using `startx` and finish the rest of the setup from there.

Finish the rest of the setup of cuckoo
```
sudo aa-disable /usr/sbin/tcpdump
sudo setcap cap_net_raw,cap_net_admin=eip /usr/sbin/tcpdump
pip install -U pip pycrypto distorm3
git clone https://github.com/volatilityfoundation/volatility
cd ~/volatility/
sudo python setup.py install
cd ~/
virtualenv cuckoo
. cuckoo/bin/activate
pip install -U yara-python==3.6.3 cuckoo
cuckoo
```

### Transfering ISOs from Windows to Ubuntu
I had some minor trouble getting the files over as file sharing between VMs can be a bit of a jerk sometimes. So I prefer using SMB for transfer. You should have a Share set up 

Connect to your share using SMB and download whatever ISOs and software you need
`smbclient -U username //10.0.0.2/d -m SMB3 -W win`
`get windows7x64.iso`

### Configuring the Guest VMs
If you make changes in networking at any level, remember to restart the networking service in Ubuntu
`sudo /etc/init.d/networking restart`

Set a static IP in each VM
* Win10x64 - 192.168.56.10
* Win7x64 - 192.168.56.15


You will also want to
* Disable the Windows Firewall
* Disable UAC (Never Notify)
* Disable Windows Updates


Download the latest [Python 2.7.x for Windows](https://www.python.org/downloads/release/python-2714/) to your Ubuntu server. Host the files a convenient place and fire up a simple server
`cd ~/Downloads`
`cp ~/cuckoo/agents/agent.py ~/Downloads`
`python -m SimpleHTTPServer`

Download the x64 MSI installer and the Cuckoo agent
`192.168.51:8000/python-2.7.14.amd64.msi`
`192.168.51:8000/agent.py`

Start the agent by opening a `Command Prompt as Administrator`.

Whilst the VMs are running, follow these steps to snapshot them (repeat for each VM):
```
VBoxManage snapshot "Win7x64" take "Win7x64_snap" --pause
VBoxManage controlvm "Win7x64" poweroff
VBoxManage snapshot "Win7x64" restorecurrent
```

In the GUI, they should appear as `Saved`


## Configuring Cuckoo


Now fire up another terminal and start the Cuckoo web GUI
`cuckoo web runserver 192.168.45.128:8080`